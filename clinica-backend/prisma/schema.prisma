generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  OWNER
  CLIENT
}

enum ReferralStatus {
  NEW
  CONTACTED
  CONVERTED
  LOST
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  DONE
  NO_SHOW
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum FinancialEntryType {
  INCOME
  EXPENSE
}

enum FinancialEntryStatus {
  PENDING
  PAID
  CANCELLED
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
}

enum ClientPackageStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

model User {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  phone           String?
  passwordHash    String
  role            UserRole
  isActive        Boolean   @default(true)
  clientProfileId String?   @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  clientProfile   Client?   @relation("ClientAccount", fields: [clientProfileId], references: [id])
  clientsCreated  Client[]  @relation("CreatedClients")
  referralsCreated Referral[] @relation("CreatedReferrals")
  appointmentsAsProfessional Appointment[] @relation("ProfessionalAppointments")
  tasksAssigned   Task[] @relation("TaskAssignedTo")
  tasksCreated    Task[] @relation("TaskCreatedBy")
  financeCreated  FinancialEntry[] @relation("FinanceCreatedBy")
  stockMovementsCreated StockMovement[] @relation("StockMovementCreatedBy")
  logs            AuditLog[]
}

model RolePermission {
  id        String   @id @default(uuid())
  role      UserRole
  moduleKey String
  canView   Boolean  @default(false)
  canCreate Boolean  @default(false)
  canEdit   Boolean  @default(false)
  canDelete Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([role, moduleKey])
}

model Client {
  id                String     @id @default(uuid())
  fullName          String
  cpf               String?
  birthDate         DateTime?
  email             String?
  phone             String?
  emergencyContact  String?
  allergies         String?
  contraindications String?
  notes             String?
  createdById       String?
  createdBy         User?      @relation("CreatedClients", fields: [createdById], references: [id])
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  accountUser       User?      @relation("ClientAccount")
  referralsMade     Referral[] @relation("Referrer")
  appointments      Appointment[]
  tasks             Task[]
  financialEntries  FinancialEntry[]
  clientPackages    ClientPackage[]
}

model Service {
  id              String   @id @default(uuid())
  name            String
  description     String?
  durationMinutes Int      @default(60)
  basePrice       Decimal  @db.Decimal(12, 2)
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  appointments      Appointment[]
  treatmentPackages TreatmentPackage[]
}

model TreatmentPackage {
  id            String   @id @default(uuid())
  name          String
  serviceId     String
  service       Service  @relation(fields: [serviceId], references: [id])
  totalSessions Int
  totalPrice    Decimal  @db.Decimal(12, 2)
  validityDays  Int      @default(180)
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clientPackages ClientPackage[]
}

model ClientPackage {
  id                String              @id @default(uuid())
  clientId          String
  packageId         String
  status            ClientPackageStatus @default(ACTIVE)
  totalSessions     Int
  remainingSessions Int
  pricePaid         Decimal?            @db.Decimal(12, 2)
  purchasedAt       DateTime            @default(now())
  expiresAt         DateTime?
  notes             String?
  createdById       String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  client            Client              @relation(fields: [clientId], references: [id])
  package           TreatmentPackage    @relation(fields: [packageId], references: [id])
  consumptions      ClientPackageConsumption[]
}

model ClientPackageConsumption {
  id              String        @id @default(uuid())
  clientPackageId String
  appointmentId   String        @unique
  consumedAt      DateTime      @default(now())
  notes           String?

  clientPackage   ClientPackage @relation(fields: [clientPackageId], references: [id])
  appointment     Appointment   @relation(fields: [appointmentId], references: [id])
}

model Appointment {
  id             String            @id @default(uuid())
  clientId       String
  serviceId      String
  professionalId String?
  startsAt       DateTime
  endsAt         DateTime
  status         AppointmentStatus @default(SCHEDULED)
  notes          String?
  createdById    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  client         Client            @relation(fields: [clientId], references: [id])
  service        Service           @relation(fields: [serviceId], references: [id])
  professional   User?             @relation("ProfessionalAppointments", fields: [professionalId], references: [id])
  packageConsumption ClientPackageConsumption?
}

model Referral {
  id                String         @id @default(uuid())
  referrerClientId  String
  referrerClient    Client         @relation("Referrer", fields: [referrerClientId], references: [id])
  referredName      String
  referredPhone     String?
  referredEmail     String?
  status            ReferralStatus @default(NEW)
  convertedClientId String?
  notes             String?
  createdById       String?
  createdBy         User?          @relation("CreatedReferrals", fields: [createdById], references: [id])
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model Task {
  id           String       @id @default(uuid())
  title        String
  description  String?
  status       TaskStatus   @default(OPEN)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?
  assignedToId String?
  assignedTo   User?        @relation("TaskAssignedTo", fields: [assignedToId], references: [id])
  clientId     String?
  client       Client?      @relation(fields: [clientId], references: [id])
  createdById  String?
  createdBy    User?        @relation("TaskCreatedBy", fields: [createdById], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model FinancialEntry {
  id          String               @id @default(uuid())
  type        FinancialEntryType
  status      FinancialEntryStatus @default(PENDING)
  description String
  amount      Decimal              @db.Decimal(12, 2)
  dueDate     DateTime?
  paidAt      DateTime?
  clientId    String?
  client      Client?              @relation(fields: [clientId], references: [id])
  createdById String?
  createdBy   User?                @relation("FinanceCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

model InventoryItem {
  id             String   @id @default(uuid())
  name           String
  sku            String?  @unique
  category       String?
  unit           String   @default("un")
  currentQty     Decimal  @default(0) @db.Decimal(12, 3)
  minQty         Decimal  @default(0) @db.Decimal(12, 3)
  costPrice      Decimal? @db.Decimal(12, 2)
  salePrice      Decimal? @db.Decimal(12, 2)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  movements      StockMovement[]
}

model StockMovement {
  id              String            @id @default(uuid())
  itemId          String
  item            InventoryItem     @relation(fields: [itemId], references: [id])
  type            StockMovementType
  quantity        Decimal           @db.Decimal(12, 3)
  reason          String?
  referenceType   String?
  referenceId     String?
  createdById     String?
  createdBy       User?             @relation("StockMovementCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime          @default(now())
}

model AppSetting {
  id         String   @id @default(uuid())
  key        String   @unique
  value      Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model OutboundMessage {
  id          String   @id @default(uuid())
  uniqueKey   String?  @unique
  kind        String
  phone       String
  status      String   // SENT | ERROR | SKIPPED
  payload     Json?
  response    Json?
  error       String?
  createdAt   DateTime @default(now())
}

model AuditLog {
  id             String   @id @default(uuid())
  actorUserId    String?
  actorRole      UserRole?
  actorUser      User?    @relation(fields: [actorUserId], references: [id])
  action         String
  entityType     String
  entityId       String?
  sourcePlatform String
  details        Json?
  createdAt      DateTime @default(now())
}
