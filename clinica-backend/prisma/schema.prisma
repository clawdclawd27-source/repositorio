generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  OWNER
  CLIENT
}

enum ReferralStatus {
  NEW
  CONTACTED
  CONVERTED
  LOST
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  DONE
  NO_SHOW
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model User {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  phone           String?
  passwordHash    String
  role            UserRole
  isActive        Boolean   @default(true)
  clientProfileId String?   @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  clientProfile   Client?   @relation("ClientAccount", fields: [clientProfileId], references: [id])
  clientsCreated  Client[]  @relation("CreatedClients")
  referralsCreated Referral[] @relation("CreatedReferrals")
  appointmentsAsProfessional Appointment[] @relation("ProfessionalAppointments")
  tasksAssigned   Task[]
  tasksCreated    Task[] @relation("TaskCreatedBy")
  logs            AuditLog[]
}

model RolePermission {
  id        String   @id @default(uuid())
  role      UserRole
  moduleKey String
  canView   Boolean  @default(false)
  canCreate Boolean  @default(false)
  canEdit   Boolean  @default(false)
  canDelete Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([role, moduleKey])
}

model Client {
  id                String     @id @default(uuid())
  fullName          String
  cpf               String?
  birthDate         DateTime?
  email             String?
  phone             String?
  emergencyContact  String?
  allergies         String?
  contraindications String?
  notes             String?
  createdById       String?
  createdBy         User?      @relation("CreatedClients", fields: [createdById], references: [id])
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  accountUser       User?      @relation("ClientAccount")
  referralsMade     Referral[] @relation("Referrer")
  appointments      Appointment[]
  tasks             Task[]
}

model Service {
  id              String   @id @default(uuid())
  name            String
  description     String?
  durationMinutes Int      @default(60)
  basePrice       Decimal  @db.Decimal(12, 2)
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  appointments    Appointment[]
}

model Appointment {
  id             String            @id @default(uuid())
  clientId       String
  serviceId      String
  professionalId String?
  startsAt       DateTime
  endsAt         DateTime
  status         AppointmentStatus @default(SCHEDULED)
  notes          String?
  createdById    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  client         Client            @relation(fields: [clientId], references: [id])
  service        Service           @relation(fields: [serviceId], references: [id])
  professional   User?             @relation("ProfessionalAppointments", fields: [professionalId], references: [id])
}

model Referral {
  id                String         @id @default(uuid())
  referrerClientId  String
  referrerClient    Client         @relation("Referrer", fields: [referrerClientId], references: [id])
  referredName      String
  referredPhone     String?
  referredEmail     String?
  status            ReferralStatus @default(NEW)
  convertedClientId String?
  notes             String?
  createdById       String?
  createdBy         User?          @relation("CreatedReferrals", fields: [createdById], references: [id])
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model Task {
  id           String       @id @default(uuid())
  title        String
  description  String?
  status       TaskStatus   @default(OPEN)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?
  assignedToId String?
  assignedTo   User?        @relation(fields: [assignedToId], references: [id])
  clientId     String?
  client       Client?      @relation(fields: [clientId], references: [id])
  createdById  String?
  createdBy    User?        @relation("TaskCreatedBy", fields: [createdById], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model AuditLog {
  id             String   @id @default(uuid())
  actorUserId    String?
  actorRole      UserRole?
  actorUser      User?    @relation(fields: [actorUserId], references: [id])
  action         String
  entityType     String
  entityId       String?
  sourcePlatform String
  details        Json?
  createdAt      DateTime @default(now())
}
